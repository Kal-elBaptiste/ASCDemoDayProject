<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Affirmation Color</title>
    <link rel="icon" href="https://img.icons8.com/?size=100&id=12939&format=png&color=000000" type="image/x-icon" />
    <link rel="stylesheet" href="style.css" />
    <script defer src="main.js"></script>
</head>
<body>
    <header>
        <div><h1>Affirmation Color</h1></div>
        <nav>
            <div class="nav-div">
                <a href="index.html">
                    <input id="nav-draw-button" class="nav-button" type="button" value="Draw" />
                </a>
            </div>
            <div class="nav-div">
                <input id="nav-view-drawings-button" class="nav-button" type="button" value="View Drawings" style="background-color: #A04D78;"/>
            </div>
        </nav>
    </header>
    <main>
        <input id="file-upload" type="file" accept="image/*" />
        <button id="upload-btn">Upload</button>
        <p id="upload-status"></p>
        <div id="imageGallery"></div>
    </main>
    <footer>
        <p>Made by Misael Godinez, Derek Chen, and Kal-El Baptiste</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.8/lib/p5.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAqwjdkD-w40DgL46s-YedVH34GaLAq8SU",
          authDomain: "asc-demo-day-project.firebaseapp.com",
          projectId: "asc-demo-day-project",
          storageBucket: "asc-demo-day-project.firebasestorage.app",
          messagingSenderId: "308081758245",
          appId: "1:308081758245:web:bb2189d93be40992c4afcc",
          measurementId: "G-5P8L1R24YG",
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        const fileInput = document.getElementById("file-upload");
        const uploadBtn = document.getElementById("upload-btn");
        const statusText = document.getElementById("upload-status");
        const imageGallery = document.getElementById("imageGallery");

        const CLOUD_NAME = "diryqa4mj";
        const UPLOAD_PRESET = "preset";

        uploadBtn.addEventListener("click", async () => {
          const file = fileInput.files[0];
          if (!file) {
            statusText.textContent = "Please select a file";
            return;
          }

          statusText.textContent = "Uploading...";

          try {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", UPLOAD_PRESET);

            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
              method: "POST",
              body: formData,
            });

            if (!response.ok) throw new Error("Upload failed");

            const data = await response.json();

            console.log("Upload successful:", data);

            // Sanitize filename or use fallback
            let imageName = data.original_filename || "unknown_file";
            imageName = imageName.toLowerCase().replace(/[^a-z0-9_\-\.]/g, "_");

            // Save image URL and sanitized name to Firestore
            await addDoc(collection(db, "images"), {
              url: data.secure_url,
              name: imageName,
              timestamp: Date.now(),
            });

            statusText.textContent = "✅ Upload complete!";
            loadAllImages();
          } catch (error) {
            console.error(error);
            statusText.textContent = "❌ Upload failed";
          }
        });

        async function loadAllImages() {
          imageGallery.innerHTML = "";
          try {
            const querySnapshot = await getDocs(collection(db, "images"));
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              if (data.url) {
                const img = document.createElement("img");
                img.src = data.url;
                img.style.width = "500px";
                img.style.margin = "5px";
                imageGallery.appendChild(img);
              }
            });
          } catch (error) {
            console.error("Error fetching images:", error);
          }
        }

        loadAllImages();
    </script>
</body>
</html>